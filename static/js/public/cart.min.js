Base.register("cart.action",function(){var a={deleteCartItem:"/index.php/Front/Cart/ajaxDelCart",getCartList:"/index.php/Front/Cart/headerCartList"},b=$(".cart"),c=b.find(".cart-list"),d=c.find(".detail"),e=b.find(".total-num"),f=b.find(".total-price"),g=b.find(".buy"),h=['<div class="empty">','<span class="tips"><i class="iconfont">&#xe63b;</i>',Base.cart.langConf.cartEmpty,"</span>","</div>"].join(" "),i=['<div class="goods-item">','<div class="goods-thumb">','<img src="<%goods_thum_images%>" alt="<%goods_name%>">',"</div>",'<div class="goods-info">','<span class="goods-title"><%goods_name%><%spec_key_name%></span>','<span class="goods-price">\uffe5<%goods_price%> &times; <%goods_num%></span>',"</div>",'<a href="#" class="goods-delete" title="<%deleteTitle%>">&times;</a>','<input type="hidden" name="goods_id" value="<%id%>">',"</div>"].join(" ");return{deleteCartItem:function(b){$.post(a.deleteCartItem,{ids:b},function(a){1==a.data.status?Base.cart.action.getCartList():Base.ui.msgBox({content:a.data.msg,type:"error"})})},getCartList:function(){$.get(a.getCartList,function(a){Base.storage.setItem("cart_list",JSON.stringify(a)),Base.cart.action.updatePriceUI(a)})},updatePriceUI:function(a){a.total_price.num?e.text(a.total_price.num).removeClass("hide"):e.text(a.total_price.num).addClass("hide"),f.text("\uffe5"+a.total_price.total_fee),a.total_price.num?(e.text(a.total_price.num).removeClass("hide"),g.removeClass("hide"),d.empty(),a.cartList.forEach(function(a){d.append(Base.dom.template(i,$.extend(a,{goods_thum_images:a.goods_thum_images?a.goods_thum_images:window.publicPath+"/image/img-placeholder.png",deleteTitle:Base.cart.langConf.deleteItem,spec_key_name:a.spec_key_name||""})))})):(d.html(h),e.text(a.total_price.num).addClass("hide"),g.addClass("hide")),Base.cart.billing.updatePriceUI(a)}}}),Base.register("cart.billing",function(){var a,b,c,d,e,f,g={balance:"/index.php/Front/Cart/balance",getAddress:"/index.php/Front/Cart/ajaxAddress",submitOrder:"/index.php/Front/Cart/submitOrder/act/submit_order",pay:"/index.php/Front/Cart/pay"},h='<option value="<%address_id%>"><%address%> - <%mobile%> - <%consignee%></option>',i='<tr><td class="empty" colspan="7">'+Base.cart.langConf.cartEmpty+"</td></tr>",j=!0;return{init:function(){$.post(g.balance,{name:"balance"},function(g){return g.data.loginStatus==-1?void Base.ui.msgBox({content:g.data.msg,type:"error"},function(){window.location.href=g.data.url}):g.data.result.cartList.length<1?void Base.ui.msgBox({content:Base.cart.langConf.outOfGoods,type:"error"}):void(a=Base.ui.popLayer({title:Base.cart.langConf.payList,width:Base.siteInfo.isMobile?320:1024,content:g.data.html,draggable:!0,confirmButton:!1},function(){var a=$(this.body);c=a.find(".table-cart-items"),b=a.find("#form-submit-cart"),d=a.find(".total-cut-price"),e=a.find(".total-price"),f=a.find(".sel-address"),Base.cart.billing.getAddress(),a.on("click","a[data-action]",function(b){b.preventDefault();var c=$(this),d=c.attr("data-action");switch(d){case"all-check":a.find(".input-check").prop("checked",!0),Base.cart.billing.updateBillingPrice();break;case"delete-check":var e=a.find(".input-check").filter(":checked"),f=[];e.length&&(e.each(function(a){f.push(e.eq(a).attr("data-id"))}),Base.cart.action.deleteCartItem(f.join(",")));break;case"del-item":Base.cart.action.deleteCartItem(c.attr("data-id"));break;case"submit":Base.cart.billing.submitOrder()}}),a.on("click",".input-check",function(){Base.cart.billing.updateBillingPrice()})},function(){a=null}))})},getAddress:function(){$.post(g.getAddress,function(a){if(a&&1==a.status){var b=a.data.result;b.length?b.forEach(function(a){f.append(Base.dom.template(h,a))}):Base.ui.msgBox({content:Base.cart.langConf.noAddress,type:"error"})}else Base.ui.msgBox({content:a.data.msg,type:"error"})})},updateBillingPrice:function(){$.post(g.balance,b.serialize(),function(a){Base.cart.billing.updatePriceUI(a.data.result,j)})},updatePriceUI:function(b,f){if(a)if(d.text("\uffe5"+b.total_price.cut_fee),e.text("\uffe5"+b.total_price.total_fee),b.total_price.num){if(!f){var g=c.find("tr[data-id]").detach();b.cartList.length&&b.cartList.forEach(function(a){g.filter('[data-id="'+a.id+'"]').appendTo(c.find("tbody"))}),g=null}}else f||c.find("tbody").html(i)},submitOrder:function(){var d=c.find(".input-check").filter(":checked");d.length&&$.post(g.submitOrder,b.serialize(),function(b){1==b.data.status?(Base.cart.billing.pay(b.data.result),a.destory(),Base.cart.action.getCartList()):Base.ui.msgBox({content:b.data.msg,type:"error"})})},pay:function(a){a&&$.post(g.pay,{order_id:a},function(a){1==a.data.status&&Base.ui.popLayer({title:Base.cart.langConf.payWay,width:Base.siteInfo.isMobile?320:600,content:a.data.html,draggable:!0,confirmButton:!1},function(){var a=$(this.body);a.find(".go-pay .btn").on("click",function(b){b.preventDefault(),a.find("#form-pay").submit()})})})}}}),Base.register("cart.init",function(){var a=$(".cart"),b=$(".cart-list"),c=b.find(".btn");Base.cart.action.getCartList(),a.on("mouseenter",function(){var a=Base.storage.getItem("cart_list");a?(a=$.parseJSON(a),Base.cart.action.updatePriceUI(a)):Base.cart.action.getCartList()}),a.on("click.deleteItem",".goods-delete",function(a){a.preventDefault();var b=$(this).siblings('input[name="goods_id"]').val();Base.cart.action.deleteCartItem(b)}),c.on("click",function(){Base.cart.billing.init()})});